#!/usr/bin/env bash

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  PATH="$shome/bin:$shome/exec:$PATH"

  # region
  local nm_region=
  if [[ -n "${1:-}" ]]; then
    nm_region="$1"; shift
    export AWS_DEFAULT_PROFILE="$nm_region"
  fi

  # target aminame
  EC2_TARGET_AMI_NAME="packer-${AWS_DEFAULT_PROFILE}-$(date +%s)"
  export EC2_TARGET_AMI_NAME

  if [[ "$#" -gt 0 ]]; then
    EC2_INSTANCE_TYPE="$1"; shift
  else
    EC2_INSTANCE_TYPE='c4.large'
  fi
  export EC2_INSTANCE_TYPE

  # source ami
  local ap_northeast_1=ami-d886a1b6
  local ap_southeast_1=ami-a17dbac2
  local ap_southeast_2=ami-067d2365
  local eu_central_1=ami-99cad9f5
  local eu_west_1=ami-a317ced0
  local sa_east_1=ami-ae44ffc2
  local us_east_1=ami-f7136c9d
  local us_west_1=ami-44b1de24
  local us_west_2=ami-46a3b427

  eval EC2_SOURCE_AMI="\$${AWS_DEFAULT_PROFILE//-/_}"
  export EC2_SOURCE_AMI

  # build it
  exec parity build ubuntu "$@"
}

source sub "$BASH_SOURCE" "$@"
